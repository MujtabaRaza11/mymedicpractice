{% unless nav_style == 'drawer' %}
  <style>
    #main-header .nav-dropdown,
    #main-header .nav-dropdown_child {
      position: absolute;
      top: 100%;
      gap: 0;
      align-items: stretch;
      flex-direction: column;
      margin-top: 1px;
      overflow: hidden;
    }
    #main-header .nav-dropdown {
      box-shadow: rgba(0, 0, 0, 0.1) 0 1px 3px 0, rgba(0, 0, 0, 0.06) 0 1px 2px 0;
    }
    #main-header .nav-dropdown_child {
      position: static;
    }
    #main-header .nav-dropdown a,
    #main-header .nav-dropdown .menu-toggle {
      display: flex;
      min-width: 20ch;
      width: 100%;
      font-size: 15px;
      line-height: 1.5;
      padding: 12px 18px;
      border-bottom: 1px solid rgb(var(--color-foreground), 0.2);
    }
  </style>
{% endunless %}

{% if nav_style == 'drawer' %}
  <style>
    #menu-drawer .menu-icon {
      max-width: 20px;
      height: auto;
      object-fit: contain;
      margin-right: 10px;
    }
    #menu-drawer ul {
      padding: 0% 0% 0% 3.5%;
    }
    
    /* Mobile menu panel system */
    .mobile-menu-container {
      position: relative;
      width: 100%;
      height: 100%;
      overflow: hidden;
    }
    
    .mobile-menu-panel {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: #FFFFFF;
      transform: translateX(100%);
      transition: transform 0.3s ease;
      opacity: 0;
      visibility: hidden;
      overflow-y: auto;
    }
    
    .mobile-menu-panel.active {
      transform: translateX(0);
      opacity: 1;
      visibility: visible;
    }
    
    .mobile-menu-main {
      transform: translateX(0);
      opacity: 1;
      visibility: visible;
      background: #FFFFFF;
    }
    
    .mobile-back-container {
      display: flex;
      justify-content: flex-end;
      padding: 10px 18px;
      border-bottom: 1px solid rgba(var(--color-foreground), 0.1);
      background: #FFFFFF;
    }
    
    .mobile-back-button {
      background: transparent;
      border: none;
      padding: 0;
      cursor: pointer;
      display: flex;
      align-items: center;
    }
    
    .mobile-back-button svg {
      width: 24px;
      height: 24px;
      color: #000000;
    }
    
    .mobile-panel-header {
      display: flex;
      align-items: center;
      padding: 12px 18px;
      border-bottom: 1px solid rgba(var(--color-foreground), 0.2);
      text-transform: uppercase;
      font-weight: 700;
      color: #ED1B24;
    }
    
    .mobile-panel-header .caret-icon {
      color: #ED1B24;
      margin-right: 8px;
    }
    
    .mobile-panel-header .caret-icon svg {
      width: 12px;
      height: 12px;
      transform: rotate(-90deg);
    }
    
    .mobile-panel-header .menu-icon {
      margin-right: 8px;
      max-width: 20px;
      height: auto;
    }
    
    .menu-forward-icon {
      margin-left: auto;
    }
    
    .menu-forward-icon svg {
      transform: rotate(-90deg);
    }
    
    .mobile-menu-link {
      display: flex;
      align-items: center;
      justify-content: space-between;
      width: 100%;
      cursor: pointer;
    }
    
    .mobile-menu-link-text {
      display: flex;
      align-items: center;
    }
  </style>
{% endif %}

<div 
  {% if nav_style == 'drawer' %}
    x-data="{
      currentPanel: 'main',
      panelHistory: [],
      
      openPanel(panel) {
        this.panelHistory.push(this.currentPanel);
        this.currentPanel = panel;
      },
      
      goBack() {
        if (this.panelHistory.length > 0) {
          this.currentPanel = this.panelHistory.pop();
        }
      }
    }"
    class="mobile-menu-container"
  {% endif %}
>
  {% if nav_style == 'drawer' %}
    <!-- Main Menu Panel -->
    <div 
      class="mobile-menu-panel mobile-menu-main" 
      :class="{ 'active': currentPanel === 'main' }"
    >
      <ul class="menu-drawer_navigation">
        {% for link in section.settings.menu.links %}
          <li>
            {% if link.links != blank %}
              <button 
                class="menu-toggle mobile-menu-link" 
                @click="openPanel('{{ link.title | escape | handleize }}')"
              >
                <span class="mobile-menu-link-text">
                  {% for block in section.blocks %}
                    {% if block.type == 'menu_icon' and block.settings.menu_title == link.title %}
                      {% if block.settings.icon %}
                        <img src="{{ block.settings.icon | img_url: '20x20' }}" alt="" class="menu-icon" width="20" height="20">
                      {% endif %}
                      {% break %}
                    {% endif %}
                  {% endfor %}
                  {{ link.title | escape }}
                </span>
                <span class="menu-forward-icon">
                  {{- 'icon-caret.svg' | inline_asset_content -}}
                </span>
              </button>
            {% else %}
              <a href="{{ link.url }}" {% if link.current %}aria-current="page"{% endif %}>
                {% for block in section.blocks %}
                  {% if block.type == 'menu_icon' and block.settings.menu_title == link.title %}
                    {% if block.settings.icon %}
                      <img src="{{ block.settings.icon | img_url: '20x20' }}" alt="" class="menu-icon" width="20" height="20">
                    {% endif %}
                    {% break %}
                  {% endif %}
                {% endfor %}
                {{ link.title | escape }}
              </a>
            {% endif %}
          </li>
        {% endfor %}
      </ul>
    </div>
    
    <!-- Secondary Menu Panels -->
    {% for link in section.settings.menu.links %}
      {% if link.links != blank %}
        <div 
          class="mobile-menu-panel" 
          :class="{ 'active': currentPanel === '{{ link.title | escape | handleize }}' }"
        >
          <div class="mobile-back-container">
            <button class="mobile-back-button" @click="goBack()">
              {{- 'icon-back.svg' | inline_asset_content -}}
            </button>
          </div>
          <div class="mobile-panel-header">
            <span class="caret-icon">{{- 'icon-caret.svg' | inline_asset_content -}}</span>
            {% for block in section.blocks %}
              {% if block.type == 'menu_icon' and block.settings.menu_title == link.title %}
                {% if block.settings.icon %}
                  <img src="{{ block.settings.icon | img_url: '20x20' }}" alt="" class="menu-icon" width="20" height="20">
                {% endif %}
                {% break %}
              {% endif %}
            {% endfor %}
            <span>{{ link.title | escape }}</span>
          </div>
          <ul class="menu-drawer_navigation">
            {% for childlink in link.links %}
              <li>
                {% if childlink.links != blank %}
                  <button 
                    class="menu-toggle mobile-menu-link" 
                    @click="openPanel('{{ link.title | escape | handleize }}-{{ childlink.title | escape | handleize }}')"
                  >
                    <span class="mobile-menu-link-text">
                      {% for block in section.blocks %}
                        {% if block.type == 'menu_icon' and block.settings.menu_title == childlink.title %}
                          {% if block.settings.icon %}
                            <img src="{{ block.settings.icon | img_url: '20x20' }}" alt="" class="menu-icon" width="20" height="20">
                          {% endif %}
                          {% break %}
                        {% endif %}
                      {% endfor %}
                      {{ childlink.title | escape }}
                    </span>
                    <span class="menu-forward-icon">
                      {{- 'icon-caret.svg' | inline_asset_content -}}
                    </span>
                  </button>
                {% else %}
                  <a href="{{ childlink.url }}" {% if childlink.current %}aria-current="page"{% endif %}>
                    {% for block in section.blocks %}
                      {% if block.type == 'menu_icon' and block.settings.menu_title == childlink.title %}
                        {% if block.settings.icon %}
                          <img src="{{ block.settings.icon | img_url: '20x20' }}" alt="" class="menu-icon" width="20" height="20">
                        {% endif %}
                        {% break %}
                      {% endif %}
                    {% endfor %}
                    {{ childlink.title | escape }}
                  </a>
                {% endif %}
              </li>
            {% endfor %}
          </ul>
        </div>
        
        <!-- Tertiary Menu Panels (Grandchildren) -->
        {% for childlink in link.links %}
          {% if childlink.links != blank %}
            <div 
              class="mobile-menu-panel" 
              :class="{ 'active': currentPanel === '{{ link.title | escape | handleize }}-{{ childlink.title | escape | handleize }}' }"
            >
              <div class="mobile-back-container">
                <button class="mobile-back-button" @click="goBack()">
                  {{- 'icon-back.svg' | inline_asset_content -}}
                </button>
              </div>
              <div class="mobile-panel-header">
                <span class="caret-icon">{{- 'icon-caret.svg' | inline_asset_content -}}</span>
                {% for block in section.blocks %}
                  {% if block.type == 'menu_icon' and block.settings.menu_title == childlink.title %}
                    {% if block.settings.icon %}
                      <img src="{{ block.settings.icon | img_url: '20x20' }}" alt="" class="menu-icon" width="20" height="20">
                    {% endif %}
                    {% break %}
                  {% endif %}
                {% endfor %}
                <span>{{ childlink.title | escape }}</span>
              </div>
              <ul class="menu-drawer_navigation">
                {% for grandchildlink in childlink.links %}
                  <li>
                    <a href="{{ grandchildlink.url }}" {% if grandchildlink.current %}aria-current="page"{% endif %}>
                      {% for block in section.blocks %}
                        {% if block.type == 'menu_icon' and block.settings.menu_title == grandchildlink.title %}
                          {% if block.settings.icon %}
                            <img src="{{ block.settings.icon | img_url: '20x20' }}" alt="" class="menu-icon" width="20" height="20">
                          {% endif %}
                          {% break %}
                        {% endif %}
                      {% endfor %}
                      {{ grandchildlink.title | escape }}
                    </a>
                  </li>
                {% endfor %}
              </ul>
            </div>
          {% endif %}
        {% endfor %}
      {% endif %}
    {% endfor %}
  {% else %}
    <!-- Regular desktop navigation -->
    <ul>
  {% for link in section.settings.menu.links %}
    <li x-data="{ menuOpen: false, activeSubMenu: null }" @click.outside="menuOpen = false; activeSubMenu = null">
      {% if link.links != blank %}
        <button
          @click="menuOpen = !menuOpen"
          :class="{ 'menu-open': menuOpen }"
          class="menu-toggle"
        >
              {% for block in section.blocks %}
                {% if block.type == 'menu_icon' and block.settings.menu_title == link.title %}
                  {% if block.settings.icon %}
                    <img src="{{ block.settings.icon | img_url: '20x20' }}" alt="" class="menu-icon" width="20" height="20">
                  {% endif %}
                  {% break %}
                {% endif %}
              {% endfor %}
          {{- link.title | escape -}}
          {{- 'icon-caret.svg' | inline_asset_content -}}
        </button>
        <ul
          x-show="menuOpen"
          class="nav-{{ nav_style }} color-{{ section.settings.menu_color_scheme }} gradient"
          x-transition
          role="list"
          x-cloak
        >
          {%- for childlink in link.links -%}
            <li>
              {% if childlink.links == blank %}
                <a
                  href="{{ childlink.url }}"
                  class="header__menu-item"
                  {% if childlink.current %}
                    aria-current="page"
                  {% endif %}
                >
                      {% for block in section.blocks %}
                        {% if block.type == 'menu_icon' and block.settings.menu_title == childlink.title %}
                          {% if block.settings.icon %}
                            <img src="{{ block.settings.icon | img_url: '20x20' }}" alt="" class="menu-icon" width="20" height="20">
                          {% endif %}
                          {% break %}
                        {% endif %}
                      {% endfor %}
                  {{ childlink.title | escape }}
                </a>
              {% else %}
                <button
                  @click="activeSubMenu = (activeSubMenu === '{{ childlink.title | escape }}' ? null : '{{ childlink.title | escape }}')"
                  :class="{ 'menu-open': activeSubMenu === '{{ childlink.title | escape }}' }"
                  class="menu-toggle"
                >
                      {% for block in section.blocks %}
                        {% if block.type == 'menu_icon' and block.settings.menu_title == childlink.title %}
                          {% if block.settings.icon %}
                            <img src="{{ block.settings.icon | img_url: '20x20' }}" alt="" class="menu-icon" width="20" height="20">
                          {% endif %}
                          {% break %}
                        {% endif %}
                      {% endfor %}
                  {{- childlink.title | escape -}}
                  {{- 'icon-caret.svg' | inline_asset_content -}}
                </button>
                <ul
                  x-show="activeSubMenu === '{{ childlink.title | escape }}'"
                  class="nav-dropdown_child"
                  x-transition
                  role="list"
                  x-cloak
                >
                  {%- for grandchildlink in childlink.links -%}
                    <li>
                      <a
                        href="{{ grandchildlink.url }}"
                        class="header__menu-item"
                        {% if grandchildlink.current %}
                          aria-current="page"
                        {% endif %}
                      >
                            {% for block in section.blocks %}
                              {% if block.type == 'menu_icon' and block.settings.menu_title == grandchildlink.title %}
                                {% if block.settings.icon %}
                                  <img src="{{ block.settings.icon | img_url: '20x20' }}" alt="" class="menu-icon" width="20" height="20">
                                {% endif %}
                                {% break %}
                              {% endif %}
                            {% endfor %}
                        {{ grandchildlink.title | escape }}
                      </a>
                    </li>
                  {%- endfor -%}
                </ul>
              {% endif %}
            </li>
          {%- endfor -%}
        </ul>
      {% else %}
        <a
          href="{{ link.url }}"
          {% if link.current %}
            aria-current="page"
          {% endif %}
        >
              {% for block in section.blocks %}
                {% if block.type == 'menu_icon' and block.settings.menu_title == link.title %}
                  {% if block.settings.icon %}
                    <img src="{{ block.settings.icon | img_url: '20x20' }}" alt="" class="menu-icon" width="20" height="20">
                  {% endif %}
                  {% break %}
                {% endif %}
              {% endfor %}
          {{- link.title | escape -}}
        </a>
      {% endif %}
    </li>
  {% endfor %}
</ul>
  {% endif %}
</div>
